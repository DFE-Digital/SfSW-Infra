name: Cleanup Container Images
on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  cleanup-acr-images:
    runs-on: ubuntu-latest
    environment: dev

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set GitHub Runner IP
      run: echo "GITHUB_RUNNER_IP=$(curl -s ifconfig.me)" >> $GITHUB_ENV

    - name: Read Config
      id: read_config
      uses: mikefarah/yq@master
      with:
        cmd: |
          echo "PROJECT_CODE=$(yq eval '.project_code' .github/config.yml)" >> $GITHUB_ENV
          echo "PROJECT_NAME=$(yq eval '.project_name' .github/config.yml)" >> $GITHUB_ENV
          echo "INSTANCE=$(yq eval '.instance' .github/config.yml)" >> $GITHUB_ENV
          echo "REGISTRY_NAME=acr$(yq eval '.project_name' .github/config.yml)$(yq eval '.instance' .github/config.yml)" >> $GITHUB_ENV
          echo "IMAGE_NAME=$(yq eval '.project_name' .github/config.yml)-app-$(yq eval '.instance' .github/config.yml)" >> $GITHUB_ENV

    - name: Azure CLI Login
      uses: azure/login@v2.2.0
      with:
        client-id: ${{ secrets.AZURE_CLIENT_ID }}
        tenant-id: ${{ secrets.AZURE_TENANT_ID }}
        subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

    - name: Enable Network Access for ACR
      uses: ./.github/actions/manage-acr-network-access
      with:
        acr-name: "acr${{ env.PROJECT_NAME }}${{ env.INSTANCE }}"
        resource-group-name: "${{ env.PROJECT_CODE }}${{ env.INSTANCE }}-rg-${{ env.PROJECT_NAME }}-app"
        github-runner-ip: ${{ env.GITHUB_RUNNER_IP }}
        enable-network-access: true

    - name: Delete ACR Images
      run: |
        echo "Checking if ACR exists: $REGISTRY_NAME"
        if ! az acr show --name "$REGISTRY_NAME" &>/dev/null; then
          echo "ACR '$REGISTRY_NAME' not found — exiting workflow."
          exit 0
        fi

        echo "Fetching image digests for $IMAGE_NAME from $REGISTRY_NAME"
        images=$(az acr repository show-manifests \
            --name "$REGISTRY_NAME" \
            --repository "$IMAGE_NAME" \
            --orderby time_desc \
            --query "[].digest" -o tsv)

        image_count=$(echo "$images" | wc -l)

        if [ "$image_count" -le 1 ]; then
            echo "Only $image_count image(s) found — nothing to delete."
            exit 0
        fi

        latest_image=$(echo "$images" | head -n 1)
            echo "Keeping latest image: $latest_image"
            echo "$images" | tail -n +2 | while read digest; do
            echo "Deleting image digest: $digest"
            az acr repository delete \
                --name "$REGISTRY_NAME" \
                --image "$IMAGE_NAME@$digest" \
                --yes
        done

    - name: Disable Network Access for ACR
      uses: ./.github/actions/manage-acr-network-access
      with:
        acr-name: "acr${{ env.PROJECT_NAME }}${{ env.INSTANCE }}"
        resource-group-name: "${{ env.PROJECT_CODE }}${{ env.INSTANCE }}-rg-${{ env.PROJECT_NAME }}-app"
        github-runner-ip: ${{ env.GITHUB_RUNNER_IP }}
        enable-network-access: false
