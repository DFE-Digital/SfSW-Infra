# can this output to $GITHUB_STEP_SUMMARY?

name: OWASP Base ZAP Security Scan (Lower Environments)

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "OWASP Base ZAP Security Scan (Lower Environments)"
        required: true
        default: dev
        type: choice
        options:
          - dev
          - test
          - pre-production

permissions:
  id-token: write
  contents: read
  
run-name: "OWASP Base ZAP Security Scan: ${{ inputs.environment }} environment"

jobs:
  zap-base-scan:
    environment: "${{ inputs.environment }}"
    env:
      SUBDOMAIN: ${{ inputs.environment == 'pre-production' && 'pre-prod' || inputs.environment }}
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Echo GitHub Runner IP
        run: |
          GITHUB_RUNNER_IP=$(curl -s https://ifconfig.me)
          echo "GITHUB_RUNNER_IP=$GITHUB_RUNNER_IP" >> $GITHUB_ENV
          echo "GitHub Runner IP: $GITHUB_RUNNER_IP"

      - name: Azure CLI Login
        uses: azure/login@v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Whitelist GH Runner IP address
        uses: ./.github/actions/whitelist-ip-address
        with:
          nsg-name-whitelist: ${{ secrets.NSG_NAME_WHITELIST }}
          infra-resource-group-name: ${{ secrets.CORE_INFRA_RG_NAME }}
          appgw-subnet: ${{ secrets.APPGW_SUBNET }}
          rule-name: "zap-scan-runner-ip"
          ip-address: ${{ env.GITHUB_RUNNER_IP }}

      - name: ZAP Base Scan
        uses: zaproxy/action-baseline@v0.15.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          docker_name: "ghcr.io/zaproxy/zaproxy:stable"
          target: "https://${{ env.SUBDOMAIN }}.support-for-social-workers.education.gov.uk/"
          cmd_options: "-a -d 1000"
          allow_issue_writing: false
          artifact_name: "zap-base-scan-report"

      - name: Download ZAP report artifact
        uses: actions/download-artifact@v7
        with:
          name: zap-base-scan-report
          path: ./zap-report

      - name: List all files in zap-report
        run: find ./zap-report

      - name: Output ZAP report to GitHub Step Summary
        if: always()
        run: |
          if [ -f ./zap-report/report_md.md ]; then
            echo "## ðŸ” OWASP ZAP Security Scan Report" >> $GITHUB_STEP_SUMMARY
            cat ./zap-report/report_md.md >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ ZAP report_md.md not found." >> $GITHUB_STEP_SUMMARY
          fi
