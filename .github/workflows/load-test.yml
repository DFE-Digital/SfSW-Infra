name: Azure Load Test

on:
  workflow_dispatch:
    # inputs:
    #   test_id:
    #     description: 'Load test ID'
    #     required: true
    #   target_url:
    #     description: 'Target URL for the load test'
    #     required: true

permissions:
    id-token: write
    contents: read

env:
  RESOURCE_GROUP: s212p01-rg-sfsw-app
  LOAD_TEST_RESOURCE: lt-sfsw-p01
  WEBAPP_URL: https://support-for-social-workers.education.gov.uk

    
jobs:
  run-load-test:
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Azure CLI Login
        uses: azure/login@v2.2.0
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Azure Load Testing
        uses: azure/load-testing@v1.1.27
        with:
          loadTestConfigFile: 'load-test/config.yml'
          loadTestResource: ${{ env.LOAD_TEST_RESOURCE}}
          resourceGroup: ${{ env.RESOURCE_GROUP }}
          env: |
            [
              {
              "name": "webapp",
              "value": "${{ env.AZURE_WEBAPP_URL }}"
              }
            ]



